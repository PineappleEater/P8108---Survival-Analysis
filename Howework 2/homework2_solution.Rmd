---
title: "Survival Analysis - Homework 2"
author: "Xuange Liang, xl3493"
date: "`r Sys.Date()`"
output:
  html_document:
    toc: true
    toc_depth: 3
    number_sections: true
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE, warning = FALSE, message = FALSE)
```

# Load Required Libraries

```{r load-libraries}
# Load necessary packages
library(survival)
library(survminer)
library(survMisc)
library(ggplot2)
library(dplyr)
library(knitr)
```

# Load Data

```{r load-data}
# Read the MI study dataset
mi_data <- read.csv("MIstudy.csv", header = TRUE)

# Display first few rows
# head(mi_data)

# Check data structure
# str(mi_data)

# Summary statistics
# summary(mi_data)
```

---

# Question 1: Logrank and Score Tests for MI Study

## Part (a): Kaplan-Meier Survival Curves

**Task:** Produce a plot showing the estimated Kaplan-Meier survival functions for the endpoint of death comparing those who are obese or overweight (BMI≥25) vs normal weight (BMI<25). Report the percentage of overweight/obese patients and comment on the censoring pattern.

```{r q1a-km-plot, fig.height=8, fig.width=10}
# Create survival object
surv_obj <- Surv(time = mi_data$dthtime, event = mi_data$dthstat)

# Fit Kaplan-Meier curves by obese_ovwt group
km_fit <- survfit(surv_obj ~ obese_ovwt, data = mi_data)

# Print summary
# summary(km_fit)

# Create KM plot
ggsurvplot(
  km_fit,
  data = mi_data,
  pval = FALSE,
  conf.int = TRUE,
  risk.table = TRUE,
  risk.table.height = 0.25,  # Adjust height ratio of risk table
  xlab = "Time (months)",
  ylab = "Survival Probability",
  legend.title = "BMI Group",
  legend.labs = c("Normal Weight (BMI<25)", "Overweight/Obese (BMI≥25)"),
  title = "Kaplan-Meier Survival Curves by BMI Category"
)

# Calculate percentage of overweight/obese patients
pct_obese_overweight <- mean(mi_data$obese_ovwt) * 100
cat("Percentage of overweight/obese patients:", round(pct_obese_overweight, 2), "%\n")

# Also, we can use the count(obse_ovwt)/sum(nrow(mi_data)) to get the percentage
sum_obese_overweight <- sum(mi_data$obese_ovwt)
pct_obese_overweight_2 <- (sum_obese_overweight / nrow(mi_data)) * 100
cat("Percentage of overweight/obese patients:", round(pct_obese_overweight_2, 2), "%\n")
```

**Answer:**

* **Percentage overweight/obese:** 60.4% of the 500 patients are either overweight or obese (BMI≥25).

* **Censoring pattern observation:** The KM plot indicates that there is a substantial amount of censoring in both groups, and most of the censoring occurs at similar time periods across both groups.



## Part (b): Logrank and Wilcoxon Tests

**Task:** Calculate both a logrank test and Wilcoxon test. State which approach you used (CMH or linear rank test). Compare the test statistics.

```{r q1b-tests}
# Logrank test (using survdiff with rho=0 for logrank)
logrank_test <- survdiff(Surv(dthtime, dthstat) ~ obese_ovwt,
                         data = mi_data,
                         rho = 0)
print("Logrank Test:")
print(logrank_test)

# Wilcoxon test (using survdiff with rho=1 for Wilcoxon)
wilcoxon_test <- survdiff(Surv(dthtime, dthstat) ~ obese_ovwt,
                          data = mi_data,
                          rho = 1)
print("Wilcoxon Test:")
print(wilcoxon_test)

# Extract test statistics
logrank_stat <- logrank_test$chisq
wilcoxon_stat <- wilcoxon_test$chisq

cat("\nLogrank test statistic:", round(logrank_stat, 4), "\n")
cat("Wilcoxon test statistic:", round(wilcoxon_stat, 4), "\n")
```

**Answer:**

* **Approach used:** I used the linear rank test approach via the `survdiff` function in R, specifying `rho=0` for the logrank test and `rho=1` for the Wilcoxon test.

* **Test statistics comparison:**
  - Logrank test statistic: 41.4, p-value: 1e-10
  - Wilcoxon test statistic: 42.6, p-value: 7e-11
  - Wilcoxon test statistic is slightly larger than the logrank test statistic. This can be predicted based on the KM curves, as the differences in survival appear to be more pronounced at earlier time points, which the Wilcoxon test weights more heavily.


## Part (c): Fleming-Harrington Tests

**Task:** Calculate Fleming-Harrington test statistics for different combinations of p and q.

```{r q1c-fh-tests}
# Fleming-Harrington test with p=0, q=0 (equivalent to logrank)
fh_00 <- survdiff(Surv(dthtime, dthstat) ~ obese_ovwt,
                  data = mi_data,
                  rho = 0)

# Fleming-Harrington test with p=1, q=0 (equivalent to Wilcoxon)
fh_10 <- survdiff(Surv(dthtime, dthstat) ~ obese_ovwt,
                  data = mi_data,
                  rho = 1)

# Fleming-Harrington test with p=1, q=1 using survMisc::comp
fh_ten <- survMisc::ten(Surv(dthtime, dthstat) ~ obese_ovwt,
                        data = mi_data)
survMisc::comp(fh_ten,
               p = c(0, 1, 1),
               q = c(0, 0, 1))
fh_lrt <- as.data.frame(attr(fh_ten, "lrt"))
fh_11 <- fh_lrt[fh_lrt$W == "FH_p=1_q=1", ]

cat("Fleming-Harrington Test Results:\n")
cat("i. p=0, q=0 (Logrank): Chi-square =", round(fh_00$chisq, 4),
    ", p-value =", round(1 - pchisq(fh_00$chisq, 1), 4), "\n")
cat("ii. p=1, q=0 (Wilcoxon): Chi-square =", round(fh_10$chisq, 4),
    ", p-value =", round(1 - pchisq(fh_10$chisq, 1), 4), "\n")
cat("iii. p=1, q=1: Chi-square =", round(fh_11$chiSq, 4),
    ", p-value =", signif(fh_11$pChisq, 3), "\n")
```

**Answer:**

* **Comparison to logrank and Wilcoxon:**
  - FH(p=0, q=0): 41.4301 — identical to logrank
  - FH(p=1, q=0): 42.6330 — identical to Wilcoxon
  - FH(p=1, q=1): 30.0323 — down-weights both tails relative to logrank/Wilcoxon

* **Power considerations:** 
  - FH(0,0) = logrank: most powerful when hazards are proportional
  - FH(1,0) = Wilcoxon: weights early failures more heavily
  - FH(1,1): weights middle failures more heavily; useful when hazards differ most mid-study


## Part (d): Proportion Test

**Task:** Test whether the proportions of deaths differ between groups, ignoring timing of death.

```{r q1d-proportion-test}
# Create 2x2 contingency table
death_table <- table(mi_data$obese_ovwt, mi_data$dthstat)
rownames(death_table) <- c("Normal Weight", "Overweight/Obese")
colnames(death_table) <- c("Censored", "Dead")
print("2x2 Contingency Table:")
print(death_table)

# Chi-square test or Fisher's exact test
prop_test <- chisq.test(death_table)
print(prop_test)

# Alternatively, using logistic regression
logistic_model <- glm(dthstat ~ obese_ovwt,
                      data = mi_data,
                      family = binomial)
print(summary(logistic_model))

# Extract p-value from logistic regression
logistic_pval <- summary(logistic_model)$coefficients[2, 4]
cat("\nLogistic regression p-value:", round(logistic_pval, 4), "\n")
```

**Answer:**

* **Test results:**
  - Chi-square/Fisher's test: Chi-square = 37.967, p-value = 0
  - OR logistic regression: Coefficient = -1.1732, p-value = 7.51e-10

* **Comparison to survival tests:** The p-values from the proportion test are similar to those from the survival analysis tests (logrank, Wilcoxon), indicating a significant difference in mortality between the BMI groups.

* **When survival analysis is more powerful:** 
  - When there is substantial censoring (?)
  - When the timing of events matters
  - When follow-up times vary considerably

---

# Question 2: Cox Model for Myocardial Infarction Study

## Part (a): Unadjusted Cox Model

**Task:** Fit an unadjusted Cox PH model with obese_ovwt as the only covariate using discrete option for ties. Report Wald, Score, and LR tests.

```{r q2a-unadjusted-cox}
# Fit unadjusted Cox model
# Note: In R, use ties="discrete" or ties="exact" for discrete method
cox_unadj <- coxph(Surv(dthtime, dthstat) ~ obese_ovwt,
                   data = mi_data,
                   ties = "breslow")  # Use "exact" for discrete method if available

# Model summary
# summary(cox_unadj)

# Extract test statistics
cox_summary <- summary(cox_unadj)
wald_stat <- cox_summary$waldtest[1]
score_stat <- cox_summary$sctest[1]
lr_stat <- cox_summary$logtest[1]

cat("\nTest Statistics:\n")
cat("Wald test: Chi-square =", round(wald_stat, 4),
    ", p-value =", round(cox_summary$waldtest[3], 4), "\n")
cat("Score test: Chi-square =", round(score_stat, 4),
    ", p-value =", round(cox_summary$sctest[3], 4), "\n")
cat("LR test: Chi-square =", round(lr_stat, 4),
    ", p-value =", round(cox_summary$logtest[3], 4), "\n")
```

**Answer:**

* **Test statistics:**
  - Wald test: Chi-square = 38.9, p-value = 0
  - Score test: Chi-square = 41.3259, p-value = 0
  - Likelihood Ratio test: Chi-square = 38.967, p-value = 0

* **Comparison to Question 1:** The Score test from the Cox model is almost identical (the difference is due to 'efron' and 'breslow' ties') to the logrank test from Question 1(b) because when the number of group is 2, those tests are equivalent. The Wald and Likelihood Ratio tests are also very close, indicating consistent results across different methods.


## Part (b): Adjusted Cox Model

**Task:** Fit an adjusted Cox model for obese_ovwt, adjusting for age, gender, sysbp, and mitype. Compare unadjusted and adjusted HRs.

```{r q2b-adjusted-cox}
# Fit adjusted Cox model
cox_adj <- coxph(Surv(dthtime, dthstat) ~ obese_ovwt + age + gender + sysbp + mitype,
                 data = mi_data,
                 ties = "efron")

# Model summary
summary(cox_adj)

# Extract hazard ratios and confidence intervals
# Unadjusted
unadj_hr <- exp(coef(cox_unadj))
unadj_ci <- exp(confint(cox_unadj))

# Adjusted
adj_hr <- exp(coef(cox_adj)["obese_ovwt"])
adj_ci <- exp(confint(cox_adj)["obese_ovwt", ])

# Create comparison table
hr_comparison <- data.frame(
  Model = c("Unadjusted", "Adjusted"),
  HR = c(unadj_hr, adj_hr),
  Lower_CI = c(unadj_ci[1], adj_ci[1]),
  Upper_CI = c(unadj_ci[2], adj_ci[2])
)
rownames(hr_comparison) <- NULL

print(hr_comparison)
```

**Answer:**
* **Unadjusted HR:** HR = 0.4232 (95% CI: 0.3230, 0.5545)

* **Adjusted HR:** HR = 0.6395 (95% CI: 0.4800, 0.8520)

* **Interpretation:** After adjusting for age, gender, systolic blood pressure, and MI type, overweight/obese individuals have a 36.0% lower risk of death compared to normal weight individuals (HR = 0.6395, 95% CI: 0.4800, 0.8520). The adjustment did not substantially change the magnitude of the effect, suggesting confounding is not an important issue.

## Part (c): Stratified vs. Controlled Analysis

**Task:** Compare test statistics for obese_ovwt from: (i) Cox model stratified by gender, (ii) Cox model controlling for gender, (iii) Logrank test stratified by gender.

```{r q2c-stratified-analysis}
# (i) Cox model stratified by gender
cox_strat <- coxph(Surv(dthtime, dthstat) ~ obese_ovwt + strata(gender),
                   data = mi_data, ties = "breslow")
summary(cox_strat)
strat_score <- cox_strat$score
strat_wald <- summary(cox_strat)$waldtest[1]
strat_lr <- summary(cox_strat)$logtest[1]

# (ii) Cox model controlling for gender
cox_control <- coxph(Surv(dthtime, dthstat) ~ obese_ovwt + gender,
                     data = mi_data, ties = "breslow")
summary(cox_control)
control_score <- cox_control$score
control_wald <- summary(cox_control)$waldtest[1]
control_lr <- summary(cox_control)$logtest[1]

# (iii) Logrank test stratified by gender
# Perform logrank test separately for each gender (we don't actually use them though)
male_logrank <- survdiff(Surv(dthtime, dthstat) ~ obese_ovwt,
                         data = subset(mi_data, gender == 0))
female_logrank <- survdiff(Surv(dthtime, dthstat) ~ obese_ovwt,
                           data = subset(mi_data, gender == 1))
# Combined stratified logrank
strat_logrank <- survdiff(Surv(dthtime, dthstat) ~ obese_ovwt + strata(gender),
                          data = mi_data)
print(strat_logrank)

# Comparison table
test_comparison <- data.frame(
  Analysis = c("Cox Stratified", "Cox Controlled", "Logrank Stratified"),
  Score = c(strat_score, control_score, strat_logrank$chisq),
  Wald = c(strat_wald, control_wald, NA),
  LR = c(strat_lr, control_lr, NA)
)
print(test_comparison)
```

**Answer:**
* **Test statistics used:**
  - (i) Stratified Cox model: Score = 35.48233
  - (ii) Controlled Cox model: Score = 43.98960
  - (iii) Stratified logrank: 35.46875

* **Comparison:** The Score statistic for the controlled Cox model is higher than that for the stratified Cox model, indicating that controlling for gender may provide a more powerful test. The Wald and LR statistics follow a similar pattern, with the controlled model showing higher values (lower p-values).

* **Power gain:** Controlling for gender rather than stratifying by gender provides a power gain, as evidenced by the higher test statistics in the controlled model. This is likely due to the more efficient use of data and the ability to estimate the effect of gender on survival.


## Part (d): Advantages/Disadvantages of Stratification

**Task:** Comment on advantages/disadvantages of stratifying by gender vs. controlling for gender. Suggest additional analyses.

**Answer:**

* **Advantages of stratification:**
  - Does not assume proportional hazards for gender
  - Allows baseline hazard to differ completely by gender

* **Disadvantages of stratification:**
  - Cannot estimate the effect of gender on survival
  - May lose power compared to controlling

* **Advantages of controlling:**
  - More efficient use of data
  - Can estimate the effect of gender
  - Allows for adjustment of confounding variables

* **Disadvantages of controlling:**
  - Assumes proportional hazards for gender
  - May be less interpretable than stratified models

* **Additional analyses to check appropriateness:**
  - Test for interaction between gender and obese_ovwt
  - Check the sample size after stratification to ensure sufficient events
  - Create KM plots stratified by gender to visually assess whether hazards cross

---

# Question 3: Model Interpretation - Myocardial Infarction Study

**Given Model Output:**

The following table shows results from a multivariable Cox proportional hazards model:

| Variable Name | Estimate | s.e. | P-value |
|--------------|----------|------|---------|
| Age | 0.0500 | 0.0066 | < 0.0001 |
| Heart rate | 0.0112 | 0.0029 | 0.0001 |
| Diastolic BP | -0.0107 | 0.0035 | 0.0024 |
| Sex (0=male, 1=female) | -0.2732 | 0.1442 | 0.0581 |
| Congestive heart failure | 0.7816 | 0.1469 | < 0.0001 |
| BMI | -0.0453 | 0.0163 | 0.0055 |

## Part (a): Write Out Estimated Hazard Function

**Task:** Write out the estimated hazard for death λ(t, Z) in Cox PH model form.

**Answer:**

$$\hat{\lambda}(t, Z) = \lambda_0(t) \times \exp[\beta_1 \times \text{Age} + \beta_2 \times \text{HR} + \beta_3 \times \text{Diastolic BP} + \beta_4 \times \text{Sex} + \beta_5 \times \text{CHF} + \beta_6 \times \text{BMI}]$$

Substituting the coefficient estimates:

$$\hat{\lambda}(t, Z) = \lambda_0(t) \times \exp[0.0500 \times \text{Age} + 0.0112 \times \text{HR} - 0.0107 \times \text{Diastolic BP} - 0.2732 \times \text{Sex} + 0.7816 \times \text{CHF} - 0.0453 \times \text{BMI}]$$

where:
- Age = patient age in years
- HR = heart rate
- Diastolic BP = diastolic blood pressure
- Sex = 0 for male, 1 for female
- CHF = 1 if congestive heart failure present, 0 otherwise
- BMI = body mass index


## Part (b): Define Baseline Group

**Task:** Define the baseline group (with hazard λ₀(t)) in terms of all covariates. Does this correspond to actual observations?

**Answer:**

The baseline group is defined as individuals with:
- Age = 0 years
- Heart rate = 0
- Diastolic BP = 0
- Sex = 0 (male)
- CHF = 0 (no congestive heart failure)
- BMI = 0

**Does this correspond to actual observations?** No, this baseline group does not correspond to actual observations in the dataset, as it is not realistic for individuals to have age, heart rate, diastolic blood pressure, and BMI equal to zero. The baseline hazard function λ₀(t) serves as a reference point for calculating relative hazards for individuals with different covariate values.


## Part (c): HR for BMI 30 vs BMI 24

**Task:** Calculate estimated HR and 95% CI for BMI=30 vs BMI=24, holding other covariates constant.

```{r q3c-bmi-hr}
# Coefficient and SE for BMI
beta_bmi <- -0.0453
se_bmi <- 0.0163

# Difference in BMI
bmi_diff <- 30 - 24

# Log hazard ratio
log_hr <- beta_bmi * bmi_diff

# Hazard ratio
hr_bmi <- exp(log_hr)

# 95% CI
se_log_hr <- se_bmi * abs(bmi_diff)
ci_lower <- exp(log_hr - 1.96 * se_log_hr)
ci_upper <- exp(log_hr + 1.96 * se_log_hr)

cat("HR for BMI 30 vs BMI 24:", round(hr_bmi, 4), "\n")
cat("95% CI: (", round(ci_lower, 4), ",", round(ci_upper, 4), ")\n")
```

**Answer:**
* **Calculation:**
  - BMI difference = 30 - 24 = 6
  - Log(HR) = β_BMI × 6 = (-0.0453) × 6 = -0.2718
  - HR = exp(-0.2718) = 0.762

* **95% Confidence Interval:**
  - SE(log HR) = SE(β_BMI) × 6 = 0.0163 × 6 = 0.0978
  - 95% CI: (0.6291, 0.923)

* **Interpretation:** Individuals with BMI of 30 have 23.8% lower risk of death compared to those with BMI of 24, adjusting for age, heart rate, diastolic BP, sex, and CHF (HR = 0.762, 95% CI: 0.6291-0.923). This association is statistically significant as the CI does not include 1.


## Part (d): HR for Age 60 vs Age 50

**Task:** Calculate estimated HR and 95% CI for age 60 vs age 50, holding other variables constant.

```{r q3d-age-hr}
# Coefficient and SE for Age
beta_age <- 0.0500
se_age <- 0.0066

# Difference in age
age_diff <- 60 - 50

# Log hazard ratio
log_hr_age <- beta_age * age_diff

# Hazard ratio
hr_age <- exp(log_hr_age)

# 95% CI
se_log_hr_age <- se_age * age_diff
ci_lower_age <- exp(log_hr_age - 1.96 * se_log_hr_age)
ci_upper_age <- exp(log_hr_age + 1.96 * se_log_hr_age)

cat("HR for Age 60 vs Age 50:", round(hr_age, 4), "\n")
cat("95% CI: (", round(ci_lower_age, 4), ",", round(ci_upper_age, 4), ")\n")
```

**Answer:**
* **Calculation:**
  - Age difference = 60 - 50 = 10
  - Log(HR) = β_Age × 10 = 0.0500 × 10 = 0.500
  - HR = exp(0.500) = 1.6487

* **95% Confidence Interval:**
  - SE(log HR) = SE(β_Age) × 10 = 0.0066 × 10 = 0.066
  - 95% CI: (1.4487, 1.8764)

* **Interpretation:** Individuals aged 60 have 64.9% higher risk of death compared to those aged 50, adjusting for heart rate, diastolic BP, sex, CHF, and BMI (HR = 1.6487, 95% CI: 1.4487-1.8764). This association is statistically significant as the CI does not include 1.


## Part (e): HR for Specific Individuals

**Task:** Calculate HR for a female aged 60 with BMI=24 versus a male aged 50 with BMI=30.

```{r q3e-individual-hr}
# Individual 1: Female, Age 60, BMI 24
# Individual 2: Male, Age 50, BMI 30

# Coefficients
beta_age <- 0.0500
beta_sex <- -0.2732
beta_bmi <- -0.0453

# Calculate linear predictor for each individual
# Assume HR, Diastolic BP, and CHF are the same for both (they cancel out)

# Individual 1 (Female, 60, BMI 24)
lp1 <- beta_age * 60 + beta_sex * 1 + beta_bmi * 24

# Individual 2 (Male, 50, BMI 30)
lp2 <- beta_age * 50 + beta_sex * 0 + beta_bmi * 30

# Log HR = difference in linear predictors
log_hr_ind <- lp1 - lp2

# HR
hr_ind <- exp(log_hr_ind)

cat("Linear predictor for Individual 1:", round(lp1, 4), "\n")
cat("Linear predictor for Individual 2:", round(lp2, 4), "\n")
cat("HR (Individual 1 vs Individual 2):", round(hr_ind, 4), "\n")
```

**Answer:**
* **Calculation:**
  - Individual 1 (female, age 60, BMI 24): LP₁ = 0.0500(60) + (-0.2732)(1) + (-0.0453)(24) = 1.6396
  - Individual 2 (male, age 50, BMI 30): LP₂ = 0.0500(50) + (-0.2732)(0) + (-0.0453)(30) = 1.141
  - Log(HR) = LP₁ - LP₂ = 0.4986
  - HR = exp(0.4986) = 1.6464

* **Interpretation:** The female aged 60 with BMI 24 has a 64.6% higher risk of death compared to the male aged 50 with BMI 30, after adjusting for other covariates.


## Part (f): Association of Sex with Risk of Death

**Task:** Describe the association of sex (male or female) with risk of death based on the model.

**Answer:**

* **Coefficient:** β_Sex = -0.2732 (SE = 0.1442, p = 0.0581)

* **Hazard Ratio:** HR = exp(-0.2732) = 0.7602

* **Interpretation:** Females have approximately 23.8% lower risk of death compared to males, adjusting for age, heart rate, diastolic BP, CHF, and BMI. However, this association is marginally non-significant at the 0.05 level (p = 0.0581), suggesting we do not have strong statistical evidence of a sex difference in mortality in this sample, though the point estimate suggests a protective effect for females.

---

# Session Information

```{r session-info}
sessionInfo()
```
